<!DOCTYPE html>
<html>
<head>
    <title>Test Extension</title>
    <style>
        body { font-family: monospace; padding: 20px; }
        button { padding: 10px 20px; margin: 10px 0; font-size: 16px; }
        pre { background: #f0f0f0; padding: 15px; border-radius: 5px; }
        .error { color: red; }
        .success { color: green; }
    </style>
</head>
<body>
    <h1>Colder Extension Test</h1>

    <button id="test1">1. Test Background Connection</button><br>
    <button id="test2">2. Get Settings</button><br>
    <button id="test3">3. Check Extension Status</button><br>

    <h3>Results:</h3>
    <pre id="output">Click a button to test...</pre>

    <script>
        const output = document.getElementById('output');

        function log(msg, isError = false) {
            const line = document.createElement('div');
            line.textContent = msg;
            line.className = isError ? 'error' : 'success';
            output.appendChild(line);
        }

        document.getElementById('test1').addEventListener('click', async () => {
            output.innerHTML = 'Testing background connection...\n';

            try {
                const response = await new Promise((resolve, reject) => {
                    const timeout = setTimeout(() => reject(new Error('Timeout after 5s')), 5000);

                    chrome.runtime.sendMessage(
                        { type: "EXTENSION_STATUS" },
                        (response) => {
                            clearTimeout(timeout);
                            if (chrome.runtime.lastError) {
                                reject(chrome.runtime.lastError);
                            } else {
                                resolve(response);
                            }
                        }
                    );
                });

                log('✓ Background is responding!');
                log('Response: ' + JSON.stringify(response, null, 2));
            } catch (err) {
                log('✗ Background NOT responding!', true);
                log('Error: ' + err.message, true);
                log('', true);
                log('This means the service worker is inactive/crashed.', true);
                log('Go to chrome://extensions/ and click "service worker"', true);
            }
        });

        document.getElementById('test2').addEventListener('click', async () => {
            output.innerHTML = 'Getting settings...\n';

            try {
                const response = await chrome.runtime.sendMessage({
                    type: "STORAGE_GET_SETTINGS"
                });

                log('✓ Settings retrieved!');
                log(JSON.stringify(response, null, 2));
            } catch (err) {
                log('✗ Failed!', true);
                log('Error: ' + err.message, true);
            }
        });

        document.getElementById('test3').addEventListener('click', async () => {
            output.innerHTML = 'Checking status directly from storage...\n';

            // Test direct storage access (bypasses background)
            chrome.storage.sync.get('extensionSettings', (data) => {
                log('✓ Direct storage read successful!');
                log('extensionSettings exists: ' + !!data.extensionSettings);

                if (data.extensionSettings) {
                    log('API Key exists: ' + !!data.extensionSettings.openrouterApiKey);
                    log('User Name: ' + data.extensionSettings.userName);
                    log('User Role: ' + data.extensionSettings.userRole);
                } else {
                    log('No settings found in storage!', true);
                }
            });
        });

        // Auto-run test 1 on load
        setTimeout(() => document.getElementById('test1').click(), 500);
    </script>
</body>
</html>
